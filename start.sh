#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ SlingCheck –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

echo "üöÄ –ó–∞–ø—É—Å–∫ SlingCheck..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "index.html" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ sling-check"
    exit 1
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "http.server 8001" 2>/dev/null
pkill -f "proxy-server.py" 2>/dev/null
sleep 1

# –ó–∞–ø—É—Å–∫–∞–µ–º CORS –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä
echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º CORS –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8002..."
python3 proxy-server.py &
PROXY_PID=$!
sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üåê –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8001..."
python3 -m http.server 8001 &
HTTP_PID=$!
sleep 2

echo ""
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
echo ""
echo "üì± –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:8001"
echo ""
echo "–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
echo "  - CORS Proxy: PID $PROXY_PID (–ø–æ—Ä—Ç 8002)"
echo "  - Web Server: PID $HTTP_PID (–ø–æ—Ä—Ç 8001)"
echo ""
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: pkill -f 'http.server 8001'"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ Ctrl+C
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä—ã..."
    kill $PROXY_PID 2>/dev/null
    kill $HTTP_PID 2>/dev/null
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

trap cleanup SIGINT SIGTERM

# –î–µ—Ä–∂–∏–º —Å–∫—Ä–∏–ø—Ç –∞–∫—Ç–∏–≤–Ω—ã–º
wait
